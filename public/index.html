<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
    <!-- Import style -->
    <link rel="stylesheet" href="//unpkg.com/element-plus/dist/index.css" />
    <!-- Import Vue 3 -->
    <script src="//unpkg.com/vue@3"></script>
    <!-- Import component library -->
    <script src="//unpkg.com/element-plus"></script>
    <script src="//unpkg.com/@element-plus/icons-vue"></script>
    <style>
      .detail-content {
        width: 660px;
        padding-right: 60px;
        margin: auto;
        height: 600px;
        overflow-y: scroll;
      }
      body, html {
        -webkit-font-smoothing: unset !important;
        font-family: -apple-system, system-ui, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif, BlinkMacSystemFont, Helvetica Neue, PingFang SC, Hiragino Sans GB, Microsoft YaHei, Arial !important;
      }
      body{
        margin: 0;
        overflow: overlay;
      }
      ::-webkit-scrollbar{
        background-color: transparent;
        width: 12px;
      }
      ::-webkit-scrollbar-thumb{
        border-radius: 8px;
        background-clip: content-box;
        border: 2px solid transparent;
        background-color: rgba(0,0,0,.2);
      }
      body[scroll]::-webkit-scrollbar-thumb,
      ::-webkit-scrollbar-thumb:hover{
        background-color: rgba(0,0,0,.5);
      }
      .deatil-bottom {
        width: 100%;
        border-top: 1px solid var(--el-border-color-light);
        padding-top: 16px;
        display: flex;
        justify-content: space-between;
      }
    </style>
</head>
<body>
  <div id="app">
    <el-card style="max-width: 800px">
      <template #header>
        <el-form :model="form" label-width="auto" >
          <el-form-item label="name" >
            <el-select
              v-model="form.novelUrl"
              placeholder="Select"
              size="large"
              @change="handleChange"
              style="width: 240px"
            >
              <el-option
                v-for="item in options"
                :key="item.value"
                :label="item.label"
                :value="item.value"
              />
            </el-select>
          </el-form-item>
        </el-form>
      </template>
      <el-tabs type="border-card" v-model="activeName">
        <el-tab-pane label="列表" name="list">
          <el-table :data="tableData" style="width: 100%" height="600">
            <el-table-column prop="title" label="标题"  >
              <template #default="scope">
                <a style="cursor: pointer;" @click="handleDetail(scope)" >{{ scope.row.title }}</a>
              </template>
            </el-table-column>
          </el-table>
        </el-tab-pane>
        <el-tab-pane :label="currTitle" name="detail">
          <div class="detail-content" v-html="message"></div>
          <el-button-group class="deatil-bottom">
            <el-button @click="handlePrevChapter"><el-icon><arrow-left-bold /></el-icon>上一章</el-button>
            <el-button @click="handleNextChapter">下一章<el-icon><arrow-right-bold /></el-icon></el-button>
          </el-button-group>
        </el-tab-pane>
      </el-tabs>
    </el-card>
    
  </div>
  <script>
    // 滚动条样式优化
    window.addEventListener('scroll', function(ev) {
      document.body.toggleAttribute('scroll', true)
      this.timer && clearTimeout(this.timer)
      this.timer = setTimeout(() => {
        document.body.toggleAttribute('scroll')
      }, 500)
    })

  </script>
  <script>
    const { createApp, ref, reactive } = Vue
  
    const app = createApp({
      setup() {
        const baseURL = 'http://www.weilaitianwang.info';
        const message = ref('Hello vue!')
        const pageType = ref('list'); // list | detail
        const currTitle = ref('详情');
        const activeName = ref('list');
        const pageIndex = ref(0);
        const options = ref([
          {
            value: 'http://www.weilaitianwang.info/137_137253/',
            label: '我戾太子只想被废'
          },
          {
            value: 'https://cn.bg3.co/novel/pagea/wolitaizizhixiangbeifei-wozhiyuzhile_155.html#google_vignette',
            label: '我戾太子只想被废-繁',
            base: 'https://cn.ttkan.co/'
          },
          {
            value: 'https://ixdzs.hk/read/494539/',
            label: '不是吧君子也防-繁',
            base: 'https://ixdzs.hk/read/494539/'
          }
        ])
        const form = reactive({
          novelUrl: '',
        })
        const chapters = ref([]);
        const tableData = ref([]);

        async function teatchChapters() {

          if (!form.novelUrl) {
            throw new Error('请选择小说');
          }
          try {
            const res = await fetch('/novels/chapters', {
              method: 'POST', // 指定请求方法为POST
              headers: {
                'Content-Type': 'application/json', // 设置请求头，告知服务器发送的是JSON数据
              },
              body: JSON.stringify({ novelUrl: form.novelUrl }), // 将novelUrl序列化为JSON放入请求体
            });

            if (!res.ok) {
              throw new Error('网络错误');
            }
            
            const data = await res.json();
            
            tableData.value = data.map(item => {
              return {
                title: item.title,
                link: item.link
              }
            })
          } catch (error) {
            console.log(error)
          }
        }
        
        const handleDetail = async (row) => {
          const data = row.row;
          pageIndex.value = row.$index

          loadDetail(data)
        }

        const loadDetail = async (data) => {
          if (!data) return console.log('load deatil error: no data')
          const res = await fetchChapterContent(baseURL + data.link);
          
          message.value =  res.content;
          currTitle.value = data.title;
          pageType.value = 'detail';
          activeName.value = 'detail';
          setTimeout(() => {
            document.querySelector('.detail-content').scrollTop  = 0;
          })
        }

        const fetchChapterContent = async (chapterUrl) => {
          try {
            const res = await fetch('/chapter/content', {
              method: 'POST', // 指定请求方法为POST
              headers: {
                'Content-Type': 'application/json', // 设置请求头，告知服务器发送的是JSON数据
              },
              body: JSON.stringify({ chapterUrl }), // 将novelUrl序列化为JSON放入请求体
            });

            if (!res.ok) {
              throw new Error(res.statusText || '网络错误'); 
            }
            
            const data = await res.json();
            
            return data;
          } catch (error) {
            console.log(error)
          }
        }

        const handleChange = async (value) => {
          form.novelUrl = value;
          teatchChapters();
        }

        const handlePrevChapter = async () => {
          if (pageIndex.value === 0) {
            return; 
          }
          pageIndex.value--;
          loadDetail(tableData.value[pageIndex.value])
        }
        const handleNextChapter = async () => {
          if (pageIndex.value === tableData.value.length - 1) {
            return;
          }
          pageIndex.value++;
          loadDetail(tableData.value[pageIndex.value])
        }
        
        return {
          message,
          chapters,
          tableData,
          currTitle,
          activeName,
          form,
          options,
          pageType,
          handleDetail,
          handleChange,
          handlePrevChapter,
          handleNextChapter
        }
      }
    })
    for ([name, comp] of Object.entries(ElementPlusIconsVue)) {
      app.component(name, comp);
    }
    console.log(ElementPlusIconsVue.ArrowRightBold)
    app.component('ArrowRightBold', ElementPlusIconsVue.ArrowRightBold)
    app.use(ElementPlus)
    
    app.mount('#app');
  </script>
</body>
</html>